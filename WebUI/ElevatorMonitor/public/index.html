<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elevator Monitor</title>
  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Elevator Monitor</h1>

  <div class="info-container">
    <!-- Current Info -->
    <div class="info-box">
      <div class="data"><span class="label">Current Floor:</span> <span id="floor">-</span></div>
      <div class="data"><span class="label">Pressure:</span> <span id="pressure">-</span> Pa</div>
      <div class="data"><span class="label">Temperature:</span> <span id="temperature">-</span> Â°C</div>
      <div class="data"><span class="label">Timestamp:</span> <span id="timestamp">-</span></div>
      <div class="data"><span class="label">Direction:</span> <span id="currentDirection">-</span></div>
      <div class="data"><span class="label">Current Trip:</span> <span id="currentTrip">-</span></div>
    </div>

    <!-- Floor Stop Count -->
    <div class="info-box">
      <h2>Floor Stop Count</h2>
      <table>
        <thead>
          <tr>
            <th>Floor</th>
            <th>Count</th>
          </tr>
        </thead>
        <tbody id="floorTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Charts -->
  <canvas id="floorPressureChart" width="900" height="400"></canvas>
  <canvas id="currentTripChart" width="900" height="400"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onChildAdded } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDF8QJaXt-0qQhhKSLVvI3jCTXhvWI7UfY",
      authDomain: "elevatormonitor-3e8cd.firebaseapp.com",
      databaseURL: "https://elevatormonitor-3e8cd-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "elevatormonitor-3e8cd",
      storageBucket: "elevatormonitor-3e8cd.firebasedatabase.app",
      messagingSenderId: "701335486505",
      appId: "1:701335486505:web:152a2a5fbc563483bedc38"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const floorEl = document.getElementById('floor');
    const pressureEl = document.getElementById('pressure');
    const tempEl = document.getElementById('temperature');
    const timestampEl = document.getElementById('timestamp');
    const floorTableBody = document.getElementById('floorTableBody');
    const currentDirectionEl = document.getElementById('currentDirection');
    const currentTripEl = document.getElementById('currentTrip');

    let lastFloorValue = null;
    let lastDirection = null;
    let currentTrip = [];
    const floorCounts = {};

    const floorPressureCtx = document.getElementById('floorPressureChart').getContext('2d');
    const floorPressureChart = new Chart(floorPressureCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Floor', data: [], borderColor: 'blue', fill: false, yAxisID: 'yFloor'},
          { label: 'Pressure', data: [], borderColor: 'green', fill: false, yAxisID: 'yPressure' }
        ]
      },
      options: { responsive: true,
        scales: {
          x: { title: { display: true, text: 'Time' } },
          yFloor: { type: 'linear', position: 'left', title: { display: true, text: 'Floor' } },
          yPressure: { type: 'linear', position: 'right', title: { display: true, text: 'Pressure (Pa)' }, grid: { drawOnChartArea: false }, reverse: true }
        }
       }
    });

    const tripCtx = document.getElementById('currentTripChart').getContext('2d');
    const tripChart = new Chart(tripCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Floor', data: [], borderColor: 'orange', fill: false, yAxisID: 'yFloor' }] },
      options: { responsive: true,
        scales: {
          x: { title: { display: true, text: 'Time' } },
          yFloor: { type: 'linear', position: 'left', title: { display: true, text: 'Floor' },}
        }
        }
    });

    const elevatorRef = ref(db, 'elevator');
    onChildAdded(elevatorRef, (snapshot) => {
      const data = snapshot.val();
      const floor = data.floor;

      floorEl.innerText = floor;
      pressureEl.innerText = data.pressure;
      tempEl.innerText = data.temperature;
      timestampEl.innerText = data.timestamp;

      // Floor stop count
      floorCounts[floor] = (floorCounts[floor] || 0) + 1;
      floorTableBody.innerHTML = '';
      Object.keys(floorCounts).sort((a,b)=>a-b).forEach(f => {
        const tr = `<tr><td>${f}</td><td>${floorCounts[f]}</td></tr>`;
        floorTableBody.innerHTML += tr;
      });

      // Trip direction & current trip
      let direction = "Stopped";
      if(lastFloorValue !== null){
        if(floor > lastFloorValue) direction = "Up";
        else if(floor < lastFloorValue) direction = "Down";
      }

      if(direction !== "Stopped"){
        if(lastDirection && direction !== lastDirection){
          currentTrip = [lastFloorValue, floor];
        } else {
          currentTrip.push(floor);
        }
      }

      lastFloorValue = floor;
      lastDirection = direction;

      currentDirectionEl.innerText = direction;
      currentTripEl.innerText = currentTrip.join(" - ");

      // Update charts
      floorPressureChart.data.labels.push(data.timestamp);
      floorPressureChart.data.datasets[0].data.push(floor);
      floorPressureChart.data.datasets[1].data.push(data.pressure);
      if(floorPressureChart.data.labels.length>50){
        floorPressureChart.data.labels.shift();
        floorPressureChart.data.datasets.forEach(ds=>ds.data.shift());
      }
      floorPressureChart.update();

      tripChart.data.labels.push(data.timestamp);
      tripChart.data.datasets[0].data.push(floor);
      if(tripChart.data.labels.length>20){
        tripChart.data.labels.shift();
        tripChart.data.datasets[0].data.shift();
      }
      tripChart.update();
    });
  </script>
</body>
</html>